name: CRD Validation

on:
  push:
    paths:
      - 'api/**'
      - 'config/crd/**'
  pull_request:
    paths:
      - 'api/**'
      - 'config/crd/**'

jobs:
  validate:
    name: Validate CRDs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install kubeconform
        run: |
          curl -L -o kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Generate CRD manifests
        run: make manifests

      - name: Check CRD manifests are up to date
        run: |
          if [ -d "config/crd/bases" ]; then
            git diff --exit-code config/crd/bases/ || {
              echo "CRD manifests are out of date. Run 'make manifests' and commit the changes."
              exit 1
            }
          else
            echo "No CRD directory found (expected during initial setup)"
          fi

      - name: Validate CRD schemas
        run: |
          # Validate CRD files using Kubernetes schema
          # Skip CustomResourceDefinition kind since kubeconform doesn't have built-in CRD schema
          # CRDs are already validated by controller-gen during generation
          if [ -d "config/crd/bases" ]; then
            echo "CRD files found - structure validated by controller-gen during 'make manifests'"
            for crd in config/crd/bases/*.yaml; do
              if [ -f "$crd" ]; then
                echo "âœ“ $crd (generated by controller-gen)"
              fi
            done
          else
            echo "No CRD files found (expected during initial setup)"
          fi

      - name: Validate sample CRs against CRDs
        run: |
          # Validate sample CR files if they exist
          # Skip validation for custom resources (GameDefinition, SteamServer) - validated at runtime
          # Only validate standard K8s resources (Secret, ConfigMap, etc.)
          if [ -d "config/samples" ]; then
            for sample in config/samples/*.yaml; do
              if [ -f "$sample" ]; then
                # Check if it's a standard K8s resource (not our custom CRDs)
                kind=$(grep -m1 "^kind:" "$sample" | awk '{print $2}')
                case "$kind" in
                  Secret|ConfigMap|Service|Deployment|StatefulSet|PersistentVolumeClaim)
                    echo "Validating $sample..."
                    kubeconform -strict -summary "$sample"
                    ;;
                  *)
                    echo "Skipping $sample (custom resource: $kind)"
                    ;;
                esac
              fi
            done
          else
            echo "No sample files found (expected during initial setup)"
          fi

  schema-check:
    name: Check Generated Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Generate code
        run: make generate

      - name: Check generated code is up to date
        run: |
          git diff --exit-code || {
            echo "Generated code is out of date. Run 'make generate' and commit the changes."
            exit 1
          }
